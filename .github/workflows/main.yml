name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v2

      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'

      - name: Install dependencies
        run: |
          npm init -y
          npm install dotenv

      - name: Create and Run Build Script
        run: |
          cat > build.js << 'EOL'
          const fs = require('fs');
          const path = require('path');
          
          // –°—Ç–≤–æ—Ä—é—î–º–æ dist –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é
          if (!fs.existsSync('dist')) {
              fs.mkdirSync('dist');
          }
          
          // –ß–∏—Ç–∞—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è –∑–º—ñ–Ω–Ω–∏—Ö —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
          const powerBiUrl = process.env.POWER_BI_URL || process.env.POWERBI_URL || "PLACEHOLDER_POWERBI_URL";
          const firebaseApiKey = process.env.FIREBASE_API_KEY || "PLACEHOLDER_FIREBASE_API_KEY";
          const firebaseAuthDomain = process.env.FIREBASE_AUTH_DOMAIN || "PLACEHOLDER_FIREBASE_AUTH_DOMAIN";
          const firebaseProjectId = process.env.FIREBASE_PROJECT_ID || "PLACEHOLDER_FIREBASE_PROJECT_ID";
          const firebaseStorageBucket = process.env.FIREBASE_STORAGE_BUCKET || "PLACEHOLDER_FIREBASE_STORAGE_BUCKET";
          const firebaseMessagingSenderId = process.env.FIREBASE_MESSAGING_SENDER_ID || "PLACEHOLDER_FIREBASE_MESSAGING_SENDER_ID";
          const firebaseAppId = process.env.FIREBASE_APP_ID || "PLACEHOLDER_FIREBASE_APP_ID";
          
          console.log('Environment variables loaded:');
          console.log('Power BI URL:', powerBiUrl.substring(0, 10) + '...');
          console.log('Firebase API Key:', firebaseApiKey.substring(0, 5) + '...');
          
          // –ó—á–∏—Ç—É—î–º–æ –≤–º—ñ—Å—Ç HTML-—Ñ–∞–π–ª—É
          let indexContent = fs.readFileSync('index.html', 'utf8');
          
          // –°—Ç–≤–æ—Ä—é—î–º–æ –∫–æ–Ω—Ñ—ñ–≥
          const configScript = `<script>
          const config = {
              powerBiUrl: "${powerBiUrl}",
              firebase: {
                  apiKey: "${firebaseApiKey}",
                  authDomain: "${firebaseAuthDomain}",
                  projectId: "${firebaseProjectId}",
                  storageBucket: "${firebaseStorageBucket}",
                  messagingSenderId: "${firebaseMessagingSenderId}",
                  appId: "${firebaseAppId}"
              }
          };
          console.log("Config loaded with actual values");
          </script>`;
          
          // –ó–∞–º—ñ–Ω—é—î–º–æ –±–ª–æ–∫ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
          if (indexContent.includes('<script src="config.js"></script>')) {
              // –ó–∞–º—ñ–Ω—é—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ config.js
              indexContent = indexContent.replace('<script src="config.js"></script>', configScript);
              console.log("Replaced config.js script tag");
          } else {
              // –®—É–∫–∞—î–º–æ —ñ–Ω–ª–∞–π–Ω –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é
              const configStartTag = '<script>\n   // This will be replaced with actual values during build';
              const configEndTag = '</script>';
              
              if (indexContent.includes(configStartTag)) {
                  // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –≤–µ—Å—å –±–ª–æ–∫ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
                  const startPos = indexContent.indexOf(configStartTag);
                  if (startPos !== -1) {
                      const endPos = indexContent.indexOf(configEndTag, startPos) + configEndTag.length;
                      const configBlock = indexContent.substring(startPos, endPos);
                      
                      // –ó–∞–º—ñ–Ω—é—î–º–æ –≤–µ—Å—å –±–ª–æ–∫
                      indexContent = indexContent.replace(configBlock, configScript);
                      console.log("Replaced inline config block");
                  }
              } else {
                  // –î–æ–¥–∞—î–º–æ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä–∏—Ç—Ç—è–º head
                  indexContent = indexContent.replace('</head>', configScript + '\n</head>');
                  console.log("Added config script before </head>");
              }
          }
          
          // –ó–∞–ø–∏—Å—É—î–º–æ –∑–º—ñ–Ω–µ–Ω–∏–π HTML —É –ø–∞–ø–∫—É dist
          fs.writeFileSync(path.join('dist', 'index.html'), indexContent);
          console.log("HTML file saved to dist folder");
          
          // –ö–æ–ø—ñ—é—î–º–æ —ñ–Ω—à—ñ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ —Ñ–∞–π–ª–∏
          const filesToCopy = [
            'icon.png', 
            'background.png', 
            'mayoly icon.png'
          ];
          
          for (const file of filesToCopy) {
            try {
              if (fs.existsSync(file)) {
                fs.copyFileSync(file, path.join('dist', file));
                console.log(`Copied: ${file}`);
              } else {
                console.log(`File not found, skipping: ${file}`);
              }
            } catch (err) {
              console.error(`Error copying ${file}:`, err);
            }
          }
          
          // –ö–æ–ø—ñ—é—î–º–æ CNAME —Ñ–∞–π–ª
          if (fs.existsSync('CNAME.txt')) {
            fs.writeFileSync(path.join('dist', 'CNAME'), fs.readFileSync('CNAME.txt', 'utf8'));
            console.log("CNAME copied from CNAME.txt");
          } else if (fs.existsSync('CNAME')) {
            fs.copyFileSync('CNAME', path.join('dist', 'CNAME'));
            console.log("CNAME file copied");
          }
          
          console.log("Build completed!");
          EOL
          
          node build.js
        env:
          POWER_BI_URL: ${{ secrets.POWER_BI_URL }}
          POWERBI_URL: ${{ secrets.POWERBI_URL }}
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}

      - name: Deploy üöÄ
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
