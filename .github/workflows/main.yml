name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v2

      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'

      - name: Install dependencies
        run: |
          npm init -y
          npm install dotenv

      - name: Create build script
        run: |
          cat > build.js << 'EOL'
          const fs = require('fs');
          const path = require('path');
          
          // –°—Ç–≤–æ—Ä—é—î–º–æ dist –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é
          if (!fs.existsSync('dist')) {
              fs.mkdirSync('dist');
          }
          
          // –ó—á–∏—Ç—É—î–º–æ –≤–º—ñ—Å—Ç HTML-—Ñ–∞–π–ª—É
          let indexContent = fs.readFileSync('index.html', 'utf8');
          
          // –°—Ç–≤–æ—Ä—é—î–º–æ –∫–æ–Ω—Ñ—ñ–≥ –∑ –∑–º—ñ–Ω–Ω–∏—Ö —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
          const runtimeConfig = {
              powerBiUrl: process.env.POWER_BI_URL,
              firebase: {
                  apiKey: process.env.FIREBASE_API_KEY,
                  authDomain: process.env.FIREBASE_AUTH_DOMAIN,
                  projectId: process.env.FIREBASE_PROJECT_ID,
                  storageBucket: process.env.FIREBASE_STORAGE_BUCKET,
                  messagingSenderId: process.env.FIREBASE_MESSAGING_SENDER_ID,
                  appId: process.env.FIREBASE_APP_ID
              }
          };
          
          // –ó–∞–º—ñ–Ω–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ config.js –Ω–∞ –≤–±—É–¥–æ–≤–∞–Ω—É –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é
          const configScriptTag = '<script src="config.js"></script>';
          const inlineConfigScript = `<script>
          const config = ${JSON.stringify(runtimeConfig, null, 2)};
          </script>`;
          
          indexContent = indexContent.replace(configScriptTag, inlineConfigScript);
          
          // –ó–∞–ø–∏—Å—É—î–º–æ –∑–º—ñ–Ω–µ–Ω–∏–π HTML —É –ø–∞–ø–∫—É dist
          fs.writeFileSync(path.join('dist', 'index.html'), indexContent);
          
          // –ö–æ–ø—ñ—é—î–º–æ —ñ–Ω—à—ñ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ —Ñ–∞–π–ª–∏
          try {
              if (fs.existsSync('icon.png')) {
                  fs.copyFileSync('icon.png', path.join('dist', 'icon.png'));
              }
              if (fs.existsSync('background.png')) {
                  fs.copyFileSync('background.png', path.join('dist', 'background.png'));
              }
              if (fs.existsSync('mayoly icon.png')) {
                  fs.copyFileSync('mayoly icon.png', path.join('dist', 'mayoly icon.png'));
              }
          } catch (err) {
              console.error('Error copying assets:', err);
          }
          
          // –ö–æ–ø—ñ—é—î–º–æ CNAME —Ñ–∞–π–ª –¥–ª—è –≤–ª–∞—Å–Ω–æ–≥–æ –¥–æ–º–µ–Ω—É
          try {
              if (fs.existsSync('CNAME.txt')) {
                  fs.writeFileSync(path.join('dist', 'CNAME'), fs.readFileSync('CNAME.txt', 'utf8'));
              } else if (fs.existsSync('CNAME')) {
                  fs.copyFileSync('CNAME', path.join('dist', 'CNAME'));
              }
          } catch (err) {
              console.error('Error copying CNAME:', err);
          }
          
          console.log('–ó–±—ñ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
          EOL

      - name: Build
        run: node build.js
        env:
          POWER_BI_URL: ${{ secrets.POWER_BI_URL }}
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
          FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}

      - name: Deploy üöÄ
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
